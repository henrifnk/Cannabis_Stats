{
  "hash": "9e1a1ee77cdc0f2aafde70755109db50",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Power Analysis Canabis\"\n---\n\n\n## Prerequisites\n\n\n\n\n\nConduct an analysis to determine the power of the study to detect a significant effect of the `treatment` and `setup` on the outcome.\nThe study is a repeated measures design between `n=10` and `n=2500` persons.\nThe repeated measures are `rep_measures=10` per person.\nThe alpha significance level is set to $\\alpha = 0.05$.\nFor each sample size, we conduct `sims=100` simulations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npossible_pers <- c(10, seq(from=50, to=1e3, by=50), 1250, 1500, 2e3, 2.5e3, 3e3)\nrep_measures <- 10\nalpha <- 0.01     \nsims <- 200 \n```\n:::\n\n\n## Simulate Data\n\nWe simulate the data for each sample size and store the results in a list of matrices.\n\n- $x_{age} \\sim Unif(18, 65)$\n- $x_{education} \\sim \\mathcal{U}\\{\"High\\_School\", \"Some\\_College\", \"Other\\_College\"\\}$\n- $x_{gender} \\sim \\mathcal{U}\\{\"male\", \"female\"\\}$\n- $x_{treatment} \\sim \\mathcal{U}\\{0, 1\\}$\n\nand the mixed effects:\n\n$\\gamma_j \\sim N(\\mu_j, 0.5)$ where the person effect $\\mu_j,\\ j \\in 1, \\ldots, 10$ are in the interval $[-3, 3]$.\n\nWe conduct power analysis for an alpha level of 0.05, a treatment effect of 0.5 and setup effects compared to \"Canabis\" of -1, 1.5, 2.5, 3.5.\nWe try to reflect a reasonable resasonable transition by the intercepts of\nc(1.7, 1.5, 0.5, 0, -0.8, -1, -1.5)` where\n\n1 --> 2  from \"Kein Strafbedürfnis\" --> \"monatliches Nettogehalt\"\n\n2 --> 3  from \"monatliches Nettogehalt\" --> \"2x monatliches Nettogehalt\"\n\n3 --> 4  from \"2x monatliches Nettogehalt\" --> \"3x monatliches Nettogehalt\"\n\n4 --> 5  from \"3x monatliches Nettogehalt\" --> \"Freiheitsstrafe bis 2 Jahre mit Bewährung\"\n\n5 --> 6  from \"Freiheitsstrafe bis 2 Jahre mit Bewährung\" --> \"Freiheitsstrafe bis 2 Jahre ohne Bewährung\"\n\n6 --> 7  from \"Freiheitsstrafe bis 2 Jahre ohne Bewährung\" --> \"Freiheitsstrafe 2 - 5 Jahre\"\n\n7 --> 8  from \"Freiheitsstrafe 2 - 5 Jahre\" --> \"Freiheitsstrafe über 5 Jahre\"\n\nFrom the data we generate Y as a mixed ordinal outcome with 8 categories and\nmodel the data with a mixed ordinal model using the `clm` function from the `ordinal` package.\nThe linear predictor is given by the formula $Y \\sim age + treatment \\times setup$.\nTODO: Try without person effect and covariate control\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta = c(\"age\" = 0.05, \"educationHS\" = -0.1, \"educationSC\" = -0.05,\n         \"educationOC\" = 0.03, \"gender\" = -0.5, \"treatmentMany\" = 1.5,\n         \"setupAlcohol\" = -0.5, \"setupStealth\" = 0.2, \"setupCocain\" = 2.5,\n         \"setupRobbery\" = 3, \"treatment:setupAlcohol\" = -0.4,\n         \"treatment:setupStealth\" = 0.4, \"treatment:setupCocain\" = 1.5,\n         \"treatment:setupRobbery\" = 1)\nintercepts <- c(-1, -3.5, -6, -7, -7.5, -7.75, -8)\np_eff = seq(-3, 3, length.out = 100)\nsim_data = simulate_mixed_ordinal(100, beta, intercepts, p_eff)\nkableExtra::kable(head(sim_data))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> age </th>\n   <th style=\"text-align:left;\"> education </th>\n   <th style=\"text-align:left;\"> gender </th>\n   <th style=\"text-align:right;\"> treatment </th>\n   <th style=\"text-align:left;\"> setup </th>\n   <th style=\"text-align:right;\"> p_id </th>\n   <th style=\"text-align:left;\"> Y </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:left;\"> High_School </td>\n   <td style=\"text-align:left;\"> male </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Canabis </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Kein Strafbedürfnis </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:left;\"> High_School </td>\n   <td style=\"text-align:left;\"> male </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Canabis </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> monatliches Nettogehalt </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:left;\"> High_School </td>\n   <td style=\"text-align:left;\"> male </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Alcohol </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Kein Strafbedürfnis </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:left;\"> High_School </td>\n   <td style=\"text-align:left;\"> male </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Alcohol </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Kein Strafbedürfnis </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:left;\"> High_School </td>\n   <td style=\"text-align:left;\"> male </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:left;\"> Stealth </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Kein Strafbedürfnis </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:left;\"> High_School </td>\n   <td style=\"text-align:left;\"> male </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> Stealth </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> monatliches Nettogehalt </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\nsummary(sim_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      age                education      gender      treatment       setup    \n Min.   :18.00   High_School  :260   male  :590   Min.   :0.0   Canabis:200  \n 1st Qu.:29.75   Some_College :390   female:410   1st Qu.:0.0   Alcohol:200  \n Median :40.00   Other_College:350                Median :0.5   Stealth:200  \n Mean   :41.41                                    Mean   :0.5   Cocain :200  \n 3rd Qu.:53.25                                    3rd Qu.:1.0   Robbery:200  \n Max.   :65.00                                    Max.   :1.0                \n                                                                             \n      p_id                                                Y      \n Min.   :  1.00   monatliches Nettogehalt                  :316  \n 1st Qu.: 25.75   2x monatliches Nettogehalt               :296  \n Median : 50.50   Kein Strafbedürfnis                      :150  \n Mean   : 50.50   Freiheitsstrafe über 5 Jahre             :108  \n 3rd Qu.: 75.25   3x monatliches Nettogehalt               : 81  \n Max.   :100.00   Freiheitsstrafe bis 2 Jahre mit Bewährung: 28  \n                  (Other)                                  : 21  \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npower_exp = lapply(possible_pers, function(pers) {\n  p_eff = seq(-3,3, length.out = pers)\n  exp = lapply(1:sims, function(sim) {\n    sim_data = simulate_mixed_ordinal(pers, beta, intercepts, p_eff)\n    model.fit = clm(Y ~ treatment * setup + age + education,\n                    data = sim_data, link = \"logit\")\n    summary(model.fit)$coefficients  # Extract p-values\n  })\n  message(Sys.time(), paste(\"          Finished\", pers, \"persons\"))\n  saveRDS(exp, paste0(\"powerexp_\", pers, \".rds\"))\n})\n```\n:::\n\n\n\n\n## Power Analysis\n\nCovariate adjusted power analysis by simulation for the ordinal model.\n\n\n::: {.cell inlcude='false'}\n\n```{.r .cell-code}\neffects = c(\"treatment\", \"setupAlcohol\", \"setupStealth\", \"setupCocain\", \"setupRobbery\",\n    \"treatment:setupAlcohol\", \"treatment:setupStealth\",\n    \"treatment:setupCocain\", \"treatment:setupRobbery\")\npower_analysis = lapply(effects, function(covar) {\n    pwr = unlist(lapply(power_exp, function(exp) {\n      p_values = sapply(exp, function(x) x[covar, \"Pr(>|z|)\"], simplify = \"vector\")\n      power = mean(sapply(p_values, function(x) x < alpha))\n    }))\n    cbind.data.frame(power = pwr, persons = possible_pers, effect = covar)\n  })\npower_analysis = rbindlist(power_analysis)\neffects[1] = \"treatmentMany\"\n```\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](pwr_analysis_files/figure-html/plot_power-1.png){width=672}\n:::\n:::\n\n\nTables with effect, effect size and power for each sample size.\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> effect </th>\n   <th style=\"text-align:right;\"> power </th>\n   <th style=\"text-align:right;\"> persons </th>\n   <th style=\"text-align:right;\"> log_odds </th>\n   <th style=\"text-align:right;\"> odds </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> setupRobbery </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> 3.0 </td>\n   <td style=\"text-align:right;\"> 20.0855369 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> setupCocain </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> 2.5 </td>\n   <td style=\"text-align:right;\"> 12.1824940 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treatment </td>\n   <td style=\"text-align:right;\"> 0.840 </td>\n   <td style=\"text-align:right;\"> 50 </td>\n   <td style=\"text-align:right;\"> 1.5 </td>\n   <td style=\"text-align:right;\"> 4.4816891 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treatment:setupCocain </td>\n   <td style=\"text-align:right;\"> 0.825 </td>\n   <td style=\"text-align:right;\"> 100 </td>\n   <td style=\"text-align:right;\"> 1.5 </td>\n   <td style=\"text-align:right;\"> 4.4816891 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treatment:setupRobbery </td>\n   <td style=\"text-align:right;\"> 0.825 </td>\n   <td style=\"text-align:right;\"> 200 </td>\n   <td style=\"text-align:right;\"> 1.0 </td>\n   <td style=\"text-align:right;\"> 2.7182818 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> setupAlcohol </td>\n   <td style=\"text-align:right;\"> 0.840 </td>\n   <td style=\"text-align:right;\"> 450 </td>\n   <td style=\"text-align:right;\"> -0.5 </td>\n   <td style=\"text-align:right;\"> 0.6065307 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treatment:setupStealth </td>\n   <td style=\"text-align:right;\"> 0.820 </td>\n   <td style=\"text-align:right;\"> 1250 </td>\n   <td style=\"text-align:right;\"> 0.4 </td>\n   <td style=\"text-align:right;\"> 1.4918247 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treatment:setupAlcohol </td>\n   <td style=\"text-align:right;\"> 0.835 </td>\n   <td style=\"text-align:right;\"> 1500 </td>\n   <td style=\"text-align:right;\"> -0.4 </td>\n   <td style=\"text-align:right;\"> 0.6703200 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> setupStealth </td>\n   <td style=\"text-align:right;\"> 0.905 </td>\n   <td style=\"text-align:right;\"> 3000 </td>\n   <td style=\"text-align:right;\"> 0.2 </td>\n   <td style=\"text-align:right;\"> 1.2214028 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [
      "pwr_analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}